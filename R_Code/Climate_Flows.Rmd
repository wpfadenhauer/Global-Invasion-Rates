---
title: "Climate_Flows"
author: "Will Pfadenhauer"
date: '2022-11-07'
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

# **Load data & packages**

```{r}
require(data.table)
require(dplyr)
require(tidyr)

#Load data
data <- fread("C:/Users/wpfadenhauer/OneDrive - University of Massachusetts/CH2_InvaderFlows/R_files/Final_Simple_Database.csv")
clim_l4 <- fread("C:/Users/wpfadenhauer/OneDrive - University of Massachusetts/CH2_InvaderFlows/R_files/Climate_Data/L4_Better_Climate_data.csv")
clim_l3 <- fread("C:/Users/wpfadenhauer/OneDrive - University of Massachusetts/CH2_InvaderFlows/R_files/Climate_Data/L3_Better_Climate_data.csv")

#Expand L4 regions
data_e <- separate_rows(data, Established_L4, sep = ",")
data_i <- separate_rows(data, Invasive_L4, sep = ",")
data_n <- separate_rows(data, Native_L4, sep = ",")

#Join regions to l4 climates
data_e <-left_join(data_e, clim_l4, by=c("Established_L4"="Level4_cod")) 
data_i <-left_join(data_i, clim_l4, by=c("Invasive_L4"="Level4_cod")) 
data_n <-left_join(data_n, clim_l4, by=c("Native_L4"="Level4_cod"))

#Join remaining invaded regions to l3 climates
data_i <-left_join(data_i, clim_l3, by=c("Invasive_L4"="LEVEL3_COD")) 
data_i <- setDT(data_i)[MAJORITY.x == "", MAJORITY.x:= MAJORITY.y]
data_i <- setDT(data_i)[is.na(MAJORITY.x), MAJORITY.x:= MAJORITY.y]

#Join remaining native regions to l3 climates
data_n <-left_join(data_n, clim_l3, by=c("Native_L4"="LEVEL3_COD")) 
data_n <- setDT(data_n)[MAJORITY.x == "", MAJORITY.x:= MAJORITY.y]
data_n <- setDT(data_n)[is.na(MAJORITY.x), MAJORITY.x:= MAJORITY.y]

#Checking for invaded misses
#data_i <- data_i[!data_i$Invasive_L4=="",]
#data_i$MAJORITY.x <- gsub("32", "", data_i$MAJORITY.x)
#data_i <- data_i[(data_i$MAJORITY.x=="" |is.na(data_i$MAJORITY.x)),]
#fixthese <- distinct(data_i,
#                     Invasive_L4)
# 0 obs. in fixthese means we're good to go.

#Checking for native misses
#data_n <- data_n[!data_n$Native_L4=="",]
#data_n$MAJORITY.x <- gsub("32", "", data_n$MAJORITY.x)
#data_n <- data_n[(data_n$MAJORITY.x=="" |is.na(data_n$MAJORITY.x)),]
#fixthese <- distinct(data_n,
#                     Native_L4)
# 0 obs. in fixthese means we're good to go.


#Recombine MAJORITY columns into strings (invaded)
data_i <- data_i %>%
  select(Accepted_name, MAJORITY.x) %>% 
  group_by(Accepted_name) %>%
  mutate(invaded_climates = paste(MAJORITY.x, collapse = ","))

data_i$invaded_climates <- gsub("NA", "", data_i$invaded_climates)

data_i <- distinct(data_i,
                  Accepted_name,
                  .keep_all = TRUE)
data_i <- data_i[,-c(2)]

#Recombine MAJORITY columns into strings (established)
data_e <- data_e %>%
  select(Accepted_name, MAJORITY) %>% 
  group_by(Accepted_name) %>%
  mutate(established_climates = paste(MAJORITY, collapse = ","))

data_e$established_climates <- gsub("NA", "", data_e$established_climates)

data_e <- distinct(data_e,
                  Accepted_name,
                  .keep_all = TRUE)
data_e <- data_e[,-c(2)]

#Recombine MAJORITY columns into strings (native)
data_n <- data_n %>%
  select(Accepted_name, MAJORITY.x) %>% 
  group_by(Accepted_name) %>%
  mutate(native_climates = paste(MAJORITY.x, collapse = ","))

data_n$native_climates <- gsub("NA", "", data_n$native_climates)

data_n <- distinct(data_n,
                  Accepted_name,
                  .keep_all = TRUE)
data_n <- data_n[,-c(2)]

#Full climate lists
name_status <- data[,c(1,2)]
full_climates <- left_join(name_status, data_n)
full_climates <- left_join(full_climates, data_e)
full_climates <- left_join(full_climates, data_i)
rm(name_status)

#Add commas to make elements easier to search
full_climates$established_climates<- paste(",",full_climates$established_climates, sep="")
full_climates$invaded_climates<- paste(",",full_climates$invaded_climates, sep="")
full_climates$native_climates<- paste(",",full_climates$native_climates, sep="")

full_climates$established_climates<- paste(full_climates$established_climates,",", sep="")
full_climates$invaded_climates<- paste(full_climates$invaded_climates,",", sep="")
full_climates$native_climates<- paste(full_climates$native_climates,",", sep="")

#Make a Data Table to Store Source Results
ClimatesAsSources <- data.table()
ClimatesAsSources$Climate <- c("Tropical", "Arid", "Temperate", "Continental", "Polar")
ClimatesAsSources$EstablishedSpecies <- ""
ClimatesAsSources$InvasiveSpecies <- ""

#Make a Data Table to Store Destination Results
ClimatesAsDestinations <- data.table()
ClimatesAsDestinations$Climate <- c("Tropical", "Arid", "Temperate", "Continental", "Polar")
ClimatesAsDestinations$EstablishedSpecies <- ""
ClimatesAsDestinations$InvasiveSpecies <- ""
```

# **Climates**

These are broken down by the Koppen Climate Classification. See
<https://en.wikipedia.org/wiki/K%C3%B6ppen_climate_classification#:~:text=The%20K%C3%B6ppen%20climate%20classification%20divides,is%20represented%20by%20a%20letter.>
for more info.

The MAJORITY numbers were calculated separately in ArcGIS Pro using the
rasters associated with this manuscript:
<http://koeppen-geiger.vu-wien.ac.at/pdf/Paper_2006.pdf> and using the
L3 and L4 shapefiles from this repository:
<https://github.com/tdwg/wgsrpd>

### **Translating numbers to Koppen Climate Codes**

-   "1" = "Af" - Tropical Rainforest
-   "2" = "Am" - Tropical Monsoon
-   "3" = "As" - Tropical Savanna (Dry Summer)
-   "4" = "Aw" - Tropical Savanna (Dry Winter)
-   "5" = "BWk" - Arid Cold Desert
-   "6" = "BWh" - Arid Hot Desert
-   "7" = "BSk" - Semi-Arid Cold
-   "8" = "BSh" - Semi-Arid Hot
-   "9" = "Cfa" - Humid SubTropical
-   "10" = "Cfb" - Oceanic
-   "11" = "Cfc" - Subpolar Oceanic
-   "12" = "Csa" - Mediterranean Hot Summer
-   "13" = "Csb" - Mediterranean Warm/Cool Summer
-   "14" = "Csc" - Mediterranean Cold Summer
-   "15" = "Cwa" - Dry Winter Humid Subtropical
-   "16" = "Cwb" - Dry Winter Subtropical Highland
-   "17" = "Cwc" - Dry Winter Cold Subtropical Highland
-   "18" = "Dfa" - No Dry Season Hot Summer Continental
-   "19" = "Dfb" - No Dry Season Warm Summer Continental/Hemiboreal
-   "20" = "Dfc" - No Dry Season Subarctic/Boreal
-   "21" = "Dfd" - No Dry Season Severe Winter Subarctic/Boreal
-   "22" = "Dsa" - Dry Summer Hot Summer Continental
-   "23" = "Dsb" - Dry Summer Hot Warm Summer Continental/Hemiboreal
-   "24" = "Dsc" - Dry Summer Subarctic/Boreal
-   "25" = "Dsd" - Dry Summer Severe Winter Subarctic/Boreal
-   "26" = "Dwa" - Dry Winter Hot Summer Continental
-   "27" = "Dwb" - Dry Winter Hot Warm Summer Continental/Hemiboreal
-   "28" = "Dwc" - Dry Winter Subarctic/Boreal
-   "29" = "Dwd" - Dry Winter Severe Winter Subactic/Boreal
-   "30" = "EF" - Tundra
-   "31" = "ET" - Ice Cap

## **A - Tropical**

### **Invasions in this Climate (destinations)**

The word "Invasions" in this document references species that have
arrived in these climates and had negative impacts. This contrasts with
the word "sources" (see next code chunk), which are the species that
originated from each climate and went elsewhere to have negative
impacts.

```{r}
#Need species with Invasive = 1-4
Tropical_I <- full_climates[grep(",1,|,2,|,3,|,4,", full_climates$invaded_climates),]

#Remove excess columns
Tropical_I <- Tropical_I[,c(1)]

#Label as invasive
Tropical_I$type = "1"

#Need species with Established = 1-4
Tropical_E <- full_climates[grep(",1,|,2,|,3,|,4,", full_climates$established_climates),]

#Remove species with Invasive = 1-4
Tropical_E <-  Tropical_E[-(grep(",1,|,2,|,3,|,4,", Tropical_E$invaded_climates)), ]

#Remove excess columns
Tropical_E <- Tropical_E[,c(1)]

#Label as established
Tropical_E$type = "0"

#Rbind Invaders to Established 
Tropical <- rbind(Tropical_I, Tropical_E)

Tropical_count <- table(Tropical$type)

ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Tropical", EstablishedSpecies:= Tropical_count[1]]
ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Tropical", InvasiveSpecies:= Tropical_count[2]]

rm(Tropical)
rm(Tropical_E)
rm(Tropical_I)
```

### **Species from this climate (sources)**

```{r}
#Need species with Native L1 =1-4
Tropical_N <- full_climates[grep(",1,|,2,|,3,|,4,", full_climates$native_climates),]

ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Tropical", EstablishedSpecies:= paste(sum(Tropical_N$status=="established"))]
ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Tropical", InvasiveSpecies:= paste(sum(Tropical_N$status=="invasive"))]

rm(Tropical_N)
```

## **B - Arid**

### **Invasions in this Climate (destinations)**

```{r}
#Need species with Invasive = 5-8
Arid_I <- full_climates[grep(",5,|,6,|,7,|,8,", full_climates$invaded_climates),]

#Remove excess columns
Arid_I <- Arid_I[,c(1)]

#Label as invasive
Arid_I$type = "1"

#Need species with Established = 5-8
Arid_E <- full_climates[grep(",5,|,6,|,7,|,8,", full_climates$established_climates),]

#Remove species with Invasive = 5-8
Arid_E <-  Arid_E[-(grep(",5,|,6,|,7,|,8,", Arid_E$invaded_climates)), ]

#Remove excess columns
Arid_E <- Arid_E[,c(1)]

#Label as established
Arid_E$type = "0"

#Rbind Invaders to Established 
Arid <- rbind(Arid_I, Arid_E)

Arid_count <- table(Arid$type)

ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Arid", EstablishedSpecies:= Arid_count[1]]
ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Arid", InvasiveSpecies:= Arid_count[2]]

rm(Arid)
rm(Arid_E)
rm(Arid_I)
```

### **Species from this climate (sources)**

```{r}
#Need species with Native L1 =5-8
Arid_N <- full_climates[grep(",5,|,6,|,7,|,8,", full_climates$native_climates),]

ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Arid", EstablishedSpecies:= paste(sum(Arid_N$status=="established"))]
ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Arid", InvasiveSpecies:= paste(sum(Arid_N$status=="invasive"))]

rm(Arid_N)
```

## **C - Temperate**

### **Invasions in this Climate (destinations)**

```{r}
#Need species with Invasive = 9-17
Temperate_I <- full_climates[grep(",9,|,10,|,11,|,12,|,13,|,14,|,15,|,16,|,17,", full_climates$invaded_climates),]

#Remove excess columns
Temperate_I <- Temperate_I[,c(1)]

#Label as invasive
Temperate_I$type = "1"

#Need species with Established = 9-17
Temperate_E <- full_climates[grep(",9,|,10,|,11,|,12,|,13,|,14,|,15,|,16,|,17,", full_climates$established_climates),]

#Remove species with Invasive = 9-17
Temperate_E <-  Temperate_E[-(grep(",9,|,10,|,11,|,12,|,13,|,14,|,15,|,16,|,17,", Temperate_E$invaded_climates)), ]

#Remove excess columns
Temperate_E <- Temperate_E[,c(1)]

#Label as established
Temperate_E$type = "0"

#Rbind Invaders to Established 
Temperate <- rbind(Temperate_I, Temperate_E)

Temperate_count <- table(Temperate$type)

ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Temperate", EstablishedSpecies:= Temperate_count[1]]
ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Temperate", InvasiveSpecies:= Temperate_count[2]]

rm(Temperate)
rm(Temperate_E)
rm(Temperate_I)
```

### **Species from this climate (sources)**

```{r}
#Need species with Native L1 =5-8
Temperate_N <- full_climates[grep(",9,|,10,|,11,|,12,|,13,|,14,|,15,|,16,|,17,", full_climates$native_climates),]

ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Temperate", EstablishedSpecies:= paste(sum(Temperate_N$status=="established"))]
ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Temperate", InvasiveSpecies:= paste(sum(Temperate_N$status=="invasive"))]

rm(Temperate_N)
```

## **D - Continental**

### **Invasions in this Climate (destinations)**

```{r}
#Need species with Invasive = 18-29
Continental_I <- full_climates[grep(",18,|,19,|,20,|,21,|,22,|,23,|,24,|,25,|,26,|,27,|,28,|,29,", full_climates$invaded_climates),]

#Remove excess columns
Continental_I <- Continental_I[,c(1)]

#Label as invasive
Continental_I$type = "1"

#Need species with Established = 18-29
Continental_E <- full_climates[grep(",18,|,19,|,20,|,21,|,22,|,23,|,24,|,25,|,26,|,27,|,28,|,29,", full_climates$established_climates),]

#Remove species with Invasive = 18-29
Continental_E <-  Continental_E[-(grep(",18,|,19,|,20,|,21,|,22,|,23,|,24,|,25,|,26,|,27,|,28,|,29,", Continental_E$invaded_climates)), ]

#Remove excess columns
Continental_E <- Continental_E[,c(1)]

#Label as established
Continental_E$type = "0"

#Rbind Invaders to Established 
Continental <- rbind(Continental_I, Continental_E)

Continental_count <- table(Continental$type)

ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Continental", EstablishedSpecies:= Continental_count[1]]
ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Continental", InvasiveSpecies:= Continental_count[2]]

rm(Continental)
rm(Continental_E)
rm(Continental_I)
```

### **Species from this climate (sources)**

```{r}
#Need species with Native L1 =5-8
Continental_N <- full_climates[grep(",18,|,19,|,20,|,21,|,22,|,23,|,24,|,25,|,26,|,27,|,28,|,29,", full_climates$native_climates),]

ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Continental", EstablishedSpecies:= paste(sum(Continental_N$status=="established"))]
ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Continental", InvasiveSpecies:= paste(sum(Continental_N$status=="invasive"))]

rm(Continental_N)
```

## **E - Polar**

### **Invasions in this Climate (destinations)**

```{r}
#Need species with Invasive = 30-31
Polar_I <- full_climates[grep(",30,|,31,", full_climates$invaded_climates),]

#Remove excess columns
Polar_I <- Polar_I[,c(1)]

#Label as invasive
Polar_I$type = "1"

#Need species with Established = 30-31
Polar_E <- full_climates[grep(",30,|,31,", full_climates$established_climates),]

#Remove species with Invasive = 30-31
Polar_E <-  Polar_E[-(grep(",30,|,31,", Polar_E$invaded_climates)), ]

#Remove excess columns
Polar_E <- Polar_E[,c(1)]

#Label as established
Polar_E$type = "0"

#Rbind Invaders to Established 
Polar <- rbind(Polar_I, Polar_E)

Polar_count <- table(Polar$type)

ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Polar", EstablishedSpecies:= Polar_count[1]]
ClimatesAsDestinations <- setDT(ClimatesAsDestinations)[Climate == "Polar", InvasiveSpecies:= Polar_count[2]]

rm(Polar)
rm(Polar_E)
rm(Polar_I)
```

### **Species from this climate (sources)**

```{r}
#Need species with Native L1 =5-8
Polar_N <- full_climates[grep(",30,|,31,", full_climates$native_climates),]

ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Polar", EstablishedSpecies:= paste(sum(Polar_N$status=="established"))]
ClimatesAsSources <- setDT(ClimatesAsSources)[Climate == "Polar", InvasiveSpecies:= paste(sum(Polar_N$status=="invasive"))]

rm(Polar_N)
```

# **Calculating Proportions**

### **Destinations**

```{r}
ClimatesAsDestinations$EstablishedSpecies <- as.integer(ClimatesAsDestinations$EstablishedSpecies)
ClimatesAsDestinations$InvasiveSpecies <- as.integer(ClimatesAsDestinations$InvasiveSpecies)
ClimatesAsDestinations$Total <- (ClimatesAsDestinations$EstablishedSpecies + ClimatesAsDestinations$InvasiveSpecies)
ClimatesAsDestinations$InvasionRate <- (ClimatesAsDestinations$InvasiveSpecies/ClimatesAsDestinations$Total)

#What's the average invasion rate for all continents?
mean(ClimatesAsDestinations$InvasionRate)

#What about if we calculate it as a weighted average based on the number of species in each continent?
ClimatesAsDestinations$PropOfTotal <- ClimatesAsDestinations$Total / 12485
ClimatesAsDestinations$WgtProp <- ClimatesAsDestinations$PropOfTotal * ClimatesAsDestinations$InvasionRate

totalprop<- sum(ClimatesAsDestinations$PropOfTotal)
#This is allowed be be >1, since species invade multiple continents

#Here's the final weighted average
(sum(ClimatesAsDestinations$WgtProp)/totalprop)

#Pretty darn close to our original average. 

#Make sure to remove all objects/values here before advancing to next code chunk. 
```

We need to adjust this average because all of the established species
have L3/L4 data, but not all the invasive species have L3/L4 data.

```{r}
#Subset invasive species
invaders <- data[data$status=="invasive",]

#Count how many have blank L3
sum(invaders$Invasive_L3 =="")

factor <- 1/((2924-885)/2924)
#So, we should be multiplying our counts of invaders in each climate by factor
```

"Projected" values

```{r}
PClimatesAsDestinations <- ClimatesAsDestinations
PClimatesAsDestinations <- PClimatesAsDestinations[,-c(4:7)]
PClimatesAsDestinations$ProjectedInvaders <- floor(PClimatesAsDestinations$InvasiveSpecies*factor)

PClimatesAsDestinations$EstablishedSpecies <- as.integer(PClimatesAsDestinations$EstablishedSpecies)
PClimatesAsDestinations$ProjectedInvaders <- as.integer(PClimatesAsDestinations$ProjectedInvaders)
PClimatesAsDestinations$Total <- (PClimatesAsDestinations$EstablishedSpecies + PClimatesAsDestinations$ProjectedInvaders)
PClimatesAsDestinations$InvasionRate <- (PClimatesAsDestinations$ProjectedInvaders/PClimatesAsDestinations$Total)

#What's the average invasion rate for all continents?
mean(PClimatesAsDestinations$InvasionRate)

#What about if we calculate it as a weighted average based on the number of species in each continent?
PClimatesAsDestinations$PropOfTotal <- PClimatesAsDestinations$Total / 12485
PClimatesAsDestinations$WgtProp <- PClimatesAsDestinations$PropOfTotal * PClimatesAsDestinations$InvasionRate

totalprop<- sum(PClimatesAsDestinations$PropOfTotal)
#This is allowed be be >1, since species invade multiple continents

#Here's the final weighted average
(sum(PClimatesAsDestinations$WgtProp)/totalprop)

#Pretty darn close to our original average. 

#Make sure to remove all objects/values here before advancing to next code chunk. 
```

### **Sources**

```{r}
ClimatesAsSources$EstablishedSpecies <- as.integer(ClimatesAsSources$EstablishedSpecies)
ClimatesAsSources$InvasiveSpecies <- as.integer(ClimatesAsSources$InvasiveSpecies)
ClimatesAsSources$Total <- (ClimatesAsSources$EstablishedSpecies + ClimatesAsSources$InvasiveSpecies)
ClimatesAsSources$InvasionRate <- (ClimatesAsSources$InvasiveSpecies/ClimatesAsSources$Total)

#What's the average invasion rate for all continents?
mean(ClimatesAsSources$InvasionRate)


#What about if we calculate it as a weighted average based on the number of species in each continent?

#Well how many species have native data in the dataset?
nativedata <- data[!Native_L1=="",]

ClimatesAsSources$PropOfTotal <- ClimatesAsSources$Total / 12170
ClimatesAsSources$WgtProp <- ClimatesAsSources$PropOfTotal * ClimatesAsSources$InvasionRate

totalprop_s<- sum(ClimatesAsSources$PropOfTotal)
#This is allowed be be >1, since species invade multiple continents

#Here's the final weighted average
(sum(ClimatesAsSources$WgtProp)/totalprop_s)
```

Need to check to see how many species have native L3/L4 data

```{r}
#Count how many have blank L3
sum(invaders$Native_L3 =="")

#That's not really enough to cause a problem. No need to run "projections" for these.
```
